<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photobooth App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .flash-active {
            animation: flashAnimation 0.5s ease-out;
        }

        @keyframes flashAnimation {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4 font-sans">

    <div class="max-w-md w-full bg-gray-800 rounded-2xl shadow-2xl p-6 flex flex-col gap-6">
        <h1 class="text-3xl font-bold text-center tracking-tight">ðŸ“¸ Photobooth</h1>

        <!-- Controls -->
        <div id="controls" class="flex items-end gap-4 justify-center">
            <div class="flex flex-col">
                <label for="timer" class="text-sm text-gray-400 mb-1">Timer (seconds)</label>
                <input type="number" id="timer" value="5" min="1" max="15"
                    class="w-20 bg-gray-700 text-white rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 text-center">
            </div>
            <button id="startBtn"
                class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                Start Booth
            </button>
        </div>

        <!-- Active Session Controls -->
        <div id="activeControls" class="hidden flex justify-center">
            <button id="cancelBtn"
                class="bg-red-600 hover:bg-red-500 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                Cancel Session
            </button>
        </div>

        <!-- Camera Area -->
        <div id="cameraArea"
            class="relative rounded-xl overflow-hidden bg-black aspect-[3/4] sm:aspect-video flex items-center justify-center border-4 border-gray-700">
            <video id="video" autoplay playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>

            <!-- Overlays -->
            <div id="flash" class="absolute inset-0 bg-white opacity-0 pointer-events-none"></div>
            <div id="countdown"
                class="absolute text-8xl font-bold text-white drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] opacity-0 transition-opacity">
            </div>

            <!-- Progress Indicators -->
            <div id="progress" class="absolute bottom-4 flex gap-2 hidden">
                <div class="w-3 h-3 rounded-full bg-gray-500 border border-white indicator"></div>
                <div class="w-3 h-3 rounded-full bg-gray-500 border border-white indicator"></div>
                <div class="w-3 h-3 rounded-full bg-gray-500 border border-white indicator"></div>
                <div class="w-3 h-3 rounded-full bg-gray-500 border border-white indicator"></div>
            </div>
        </div>

        <!-- Result Area (Hidden initially) -->
        <div id="resultArea" class="hidden flex-col items-center gap-4">
            <div class="bg-white p-2 rounded shadow-lg">
                <img id="stripImage" class="max-h-[60vh] object-contain block" alt="Your Photo Strip">
            </div>
            <div class="flex gap-4 w-full">
                <button id="retakeBtn"
                    class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                    Retake
                </button>
                <button id="downloadBtn"
                    class="flex-1 bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                    Download Strip
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden canvas for processing -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const timerInput = document.getElementById('timer');
        const countdownEl = document.getElementById('countdown');
        const flashEl = document.getElementById('flash');
        const cameraArea = document.getElementById('cameraArea');
        const resultArea = document.getElementById('resultArea');
        const controls = document.getElementById('controls');
        const activeControls = document.getElementById('activeControls');
        const cancelBtn = document.getElementById('cancelBtn');
        const stripImage = document.getElementById('stripImage');
        const downloadBtn = document.getElementById('downloadBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const indicators = document.querySelectorAll('.indicator');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let stream = null;
        let photos = [];
        let cancelRequested = false;

        // Audio Context for shutter sound
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playShutterSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            // Create a short "snap" sound
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.05);

            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.05);
        }

        // Initialize camera
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } }
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                countdownEl.innerText = "Camera access denied";
                countdownEl.classList.remove('opacity-0');
                countdownEl.classList.add('text-2xl', 'text-red-500');
            }
        }

        const sleep = ms => new Promise(r => setTimeout(r, ms));

        async function startPhotobooth() {
            photos = [];
            cancelRequested = false;
            const seconds = parseInt(timerInput.value) || 5;

            controls.classList.add('hidden');
            activeControls.classList.remove('hidden');
            document.getElementById('progress').classList.remove('hidden');
            indicators.forEach(ind => ind.classList.replace('bg-white', 'bg-gray-500'));

            for (let i = 0; i < 4; i++) {
                // Countdown loop
                for (let t = seconds; t > 0; t--) {
                    if (cancelRequested) break;
                    countdownEl.innerText = t;
                    countdownEl.classList.remove('opacity-0');
                    await sleep(1000);
                }

                if (cancelRequested) break;

                countdownEl.classList.add('opacity-0');
                takePhoto();
                indicators[i].classList.replace('bg-gray-500', 'bg-white');

                if (i < 3 && !cancelRequested) await sleep(500); // Brief pause before next countdown
            }

            document.getElementById('progress').classList.add('hidden');
            activeControls.classList.add('hidden');
            countdownEl.classList.add('opacity-0');

            if (cancelRequested) {
                resetBooth();
                return;
            }

            generateStrip();
        }

        function takePhoto() {
            // Play shutter sound
            playShutterSound();

            // Flash effect
            flashEl.classList.remove('flash-active');
            void flashEl.offsetWidth; // Trigger reflow
            flashEl.classList.add('flash-active');

            // Capture frame to temporary canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');

            // Mirror image horizontally to match preview
            tempCtx.translate(tempCanvas.width, 0);
            tempCtx.scale(-1, 1);
            tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);

            photos.push(tempCanvas);
        }

        function generateStrip() {
            if (photos.length === 0) return;

            const padding = 20;
            const pWidth = photos[0].width;
            const pHeight = photos[0].height;

            // Setup final strip canvas
            canvas.width = pWidth + (padding * 2);
            canvas.height = (pHeight * 4) + (padding * 5);

            // Draw background (white)
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw photos onto strip
            photos.forEach((photoCanvas, index) => {
                const y = padding + (index * (pHeight + padding));
                ctx.drawImage(photoCanvas, padding, y, pWidth, pHeight);
            });

            // Show result
            stripImage.src = canvas.toDataURL('image/png');
            cameraArea.classList.add('hidden');
            resultArea.classList.remove('hidden');
            resultArea.classList.add('flex');
        }

        function resetBooth() {
            resultArea.classList.add('hidden');
            resultArea.classList.remove('flex');
            cameraArea.classList.remove('hidden');
            controls.classList.remove('hidden');
            activeControls.classList.add('hidden');
            document.getElementById('progress').classList.add('hidden');
            countdownEl.classList.add('opacity-0');
            photos = [];
            cancelRequested = false;
        }

        function downloadStrip() {
            const link = document.createElement('a');
            link.download = `photobooth-${new Date().getTime()}.png`;
            link.href = stripImage.src;
            link.click();
        }

        // Event Listeners
        startBtn.addEventListener('click', startPhotobooth);
        cancelBtn.addEventListener('click', () => { cancelRequested = true; });
        retakeBtn.addEventListener('click', resetBooth);
        downloadBtn.addEventListener('click', downloadStrip);

        // Start camera on load
        window.addEventListener('load', initCamera);
    </script>
</body>

</html>